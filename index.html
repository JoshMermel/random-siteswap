<!doctype html>
<html>

<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/7.1.0/bootstrap-slider.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/7.1.0/css/bootstrap-slider.min.css" />
</head>

<body onload="update()">

  <div class="container">
    <div class="row">
      <div class="col-md-6" id="io">
        <h1>Random Siteswaps</h1>
        <div>
          Siteswap Length: <input type="text" id="length" onchange="update()"><br>
          Number of Objects: <input type="text" id="num_balls" onchange="update()"><br>
          Max Multiplex at once: <input type="text" id="max_multiplicity" onchange="update()"><br>
          Max Throw (experimental): <input type="text" id="max_throw" onchange="update()"><br>
          Min Throw (experimental): <input type="text" id="min_throw" onchange="update()"><br>
        </div>

        <hr/>
        <div>
          <input type="radio" id="async" name="is_sync" value="async" onclick="update()" checked>
          <label for="async">Async</label>
        </div>
        <div>
          <input type="radio" id="sync" name="is_sync" value="sync" onclick="update()" checked>
          <label for="sync">Sync</label>
        </div>
        <hr>

        <button onclick="update()" type="button">Another one</button>
        <hr>

        <p style="font-size:30px" id="siteswap_out"></p>
      </div>

      <div class="col-md-6" id="animation">
        <canvas id="canvas" width=350px height=600px></canvas>
        <div> Animation speed </div>
        <input id="animation_speed" type="text" data-slider-min="1" data-slider-max="40" data-slider-step="1" data-slider-value="10" /></input>
        <hr/>
        <div>
          <input type="radio" id="random_colors" name="colors" value="random_colors" onclick="recolorRandomly()" checked>
          <label for="random_colors">Random Colors</label>
        </div>
        <div>
          <input type="radio" id="color_by_orbit" name="colors" value="color_by_orbit" onclick="recolorByOrbit()" checked>
          <label for="color_by_orbit">Color by Orbit</label>
        </div>

      </div>
    </div>
  </div>


</body>

<script src="random.js"></script>
<script src="constraints.js"></script>
<script src="anim.js"></script>
<script>
window.onload = function() {
  $("#animation_speed").slider({
    value: 10
  });
  $("#animation_speed").on("change", function(slideEvt) {
    pace = slideEvt.value.newValue / 160;
  });
  document.getElementById("length").value = randInt(2,5);
  document.getElementById("num_balls").value = randInt(4,7);
  document.getElementById("max_multiplicity").value = randInt(1,3);
  update();
  StartAnimation();
}
function update(attempts) {
  if (attempts === undefined) {
    attempts = 0;
  }
  let length = document.getElementById("length").value;
  let num_balls = document.getElementById("num_balls").value;
  let max_multiplicity = document.getElementById("max_multiplicity").value;
  let is_sync = (document.querySelector('input[name="is_sync"]:checked').value === "sync");
  let color_by_orbit = (document.querySelector('input[name="colors"]:checked').value === "color_by_orbit");
  let max_throw = document.getElementById("max_throw").value;
  let min_throw = document.getElementById("min_throw").value;

  // TODO(jmerm): cap this length;
  if (length < 1) {
    document.getElementById("siteswap_out").innerHTML = "Length must be 1 or more";
  } else if (num_balls < 1) {
    document.getElementById("siteswap_out").innerHTML = "Number of objects must be 1 or more";
  } else if (max_multiplicity < 1) {
    document.getElementById("siteswap_out").innerHTML = "Max multiplicity must be 1 or more";
  } else {
    
    let siteswap = randomSiteswap(length, num_balls, max_multiplicity, is_sync);
    
    // apply min and max
    if (max_throw !== "" && max_throw > num_balls) {
      applyMax(siteswap, max_throw);
      if (!maxConstraintSatisfied(siteswap, max_throw) && attempts < 100) {
        console.log(JSON.stringify(siteswap), " failed max constraint");
        update(attempts + 1);
        return;
      }
    }
    if (min_throw !== "" && min_throw < num_balls) {
      applyMin(siteswap, min_throw);
      if (!minConstraintSatisfied(siteswap, min_throw) && attempts < 100) {
        console.log(JSON.stringify(siteswap), " failed min constraint");
        update(attempts + 1);
        return;
      }
    }

    if (attempts > 0) {
      console.log("had to restart generation ", attempts, " times.");
    }

    let siteswap_str = "";
    if (is_sync) {
      siteswap_str = printSyncSiteswap(siteswap);
    } else {
      siteswap_str = printAsyncSiteswap(siteswap);
    }

    if (siteswap_str == document.getElementById("siteswap_out").innerHTML && attempts < 100) {
      console.log("generated the last thing as last time, retrying");
      update(attempts + 1);
      return;
    }

    document.getElementById("siteswap_out").innerHTML = siteswap_str;
    setSiteswap(siteswap, color_by_orbit, is_sync);
    StartAnimation();
  }
}
</script>
</html>
